apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sochdb.fullname" . }}-config
  labels:
    {{- include "sochdb.labels" . | nindent 4 }}
data:
  sochdb.toml: |
    # SochDB Configuration
    # Auto-generated by Helm chart
    
    [server]
    grpc_port = {{ .Values.service.grpcPort }}
    http_port = {{ .Values.service.httpPort }}
    data_dir = "/data"
    
    [boot]
    recovery_mode = "{{ .Values.boot.recoveryMode }}"
    
    [boot.budgets]
    init_seconds = {{ .Values.boot.budgets.initSeconds }}
    migrate_seconds = {{ .Values.boot.budgets.migrateSeconds }}
    recover_seconds = {{ .Values.boot.budgets.recoverSeconds }}
    warmup_seconds = {{ .Values.boot.budgets.warmupSeconds }}
    
    [durability]
    level = "{{ .Values.durability.level }}"
    {{- if eq .Values.durability.level "group_commit" }}
    
    [durability.group_commit]
    max_batch = {{ .Values.durability.groupCommit.maxBatch }}
    flush_interval_ms = {{ .Values.durability.groupCommit.flushIntervalMs }}
    {{- end }}
    
    [durability.archiving]
    enabled = {{ .Values.durability.archiving.enabled }}
    {{- if .Values.durability.archiving.destination }}
    destination = "{{ .Values.durability.archiving.destination }}"
    {{- end }}
    
    [checkpoint]
    mode = "{{ .Values.checkpoint.mode }}"
    wal_size_trigger_mb = {{ .Values.checkpoint.walSizeTriggerMB }}
    max_duration_seconds = {{ .Values.checkpoint.maxDurationSeconds }}
    
    [admission_control]
    enabled = {{ .Values.admissionControl.enabled }}
    queue_depth_warning = {{ .Values.admissionControl.queueDepthWarning }}
    queue_depth_rejection = {{ .Values.admissionControl.queueDepthRejection }}
    allow_partial_results = {{ .Values.admissionControl.allowPartialResults }}
    
    {{- if .Values.security.tls.enabled }}
    [security.tls]
    enabled = true
    cert_path = "/etc/sochdb/tls/tls.crt"
    key_path = "/etc/sochdb/tls/tls.key"
    mtls = {{ .Values.security.tls.mtls }}
    {{- end }}
    
    {{- if .Values.security.auth.enabled }}
    [security.auth]
    enabled = true
    jwks_url = "{{ .Values.security.auth.jwksUrl }}"
    issuer = "{{ .Values.security.auth.issuer }}"
    {{- end }}
    
    [observability.metrics]
    enabled = {{ .Values.observability.metrics.enabled }}
    port = {{ .Values.observability.metrics.port }}
    path = "{{ .Values.observability.metrics.path }}"
    
    [observability.tracing]
    enabled = {{ .Values.observability.tracing.enabled }}
    {{- if .Values.observability.tracing.endpoint }}
    endpoint = "{{ .Values.observability.tracing.endpoint }}"
    {{- end }}
    sampling_rate = {{ .Values.observability.tracing.samplingRate }}
