# =============================================================================
# ToonDB Unified Release Pipeline
# =============================================================================
#
# Single workflow that releases all SDK packages atomically:
#   - crates.io: toondb (Rust)
#   - PyPI: toondb-client (Python)
#   - npm: @sushanth/toondb (JavaScript)
#   - Go modules: github.com/toondb/toondb/toondb-go (Go)
#
# Principle: When version changes, it changes everywhere.
# =============================================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.2.3)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (validate without publishing)'
        required: false
        default: false
        type: boolean
      targets:
        description: 'What to release'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - rust
          - python
          - npm
          - go

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Validate - Tests, formatting, and version consistency
  # ===========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Run Rust tests
        run: cargo test --release --workspace

      - name: Validate Python package
        run: |
          cd toondb-python-sdk
          pip install build twine
          python -m build --sdist
          twine check dist/*

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JavaScript package
        run: |
          cd toondb-js
          npm ci
          npm run build
          npm test

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: toondb-go/go.sum

      - name: Validate Go package
        run: |
          cd toondb-go
          go mod download
          go build -v ./...
          go test -v ./...

  # ===========================================================================
  # Publish Rust crates to crates.io
  # ===========================================================================
  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'rust' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Publish crates (dependency order)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          DRY_RUN="${{ inputs.dry_run }}"
          
          publish_crate() {
            local crate=$1
            echo "ðŸ“¦ Publishing $crate..."
            cd $crate
            if [ "$DRY_RUN" = "true" ]; then
              cargo publish --dry-run
            else
              cargo publish --allow-dirty || echo "âš ï¸ $crate may already be published"
              sleep 30  # Wait for crates.io to index
            fi
            cd ..
          }
          
          # Publish in dependency order
          publish_crate toondb-core
          publish_crate toondb-storage
          publish_crate toondb-index
          publish_crate toondb-query
          publish_crate toondb-client  # Published as 'toondb' on crates.io

  # ===========================================================================
  # Build Python wheels for all platforms
  # ===========================================================================
  build-python-linux:
    name: Build Python (Linux x86_64)
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'python' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust libraries
        run: cargo build --release -p toondb-tools -p toondb-storage -p toondb-index

      - name: Copy binaries to SDK
        run: |
          mkdir -p toondb-python-sdk/src/toondb/lib/x86_64-unknown-linux-gnu
          mkdir -p toondb-python-sdk/src/toondb/_bin/x86_64-unknown-linux-gnu
          cp target/release/libtoondb_storage.so toondb-python-sdk/src/toondb/lib/x86_64-unknown-linux-gnu/
          cp target/release/libtoondb_index.so toondb-python-sdk/src/toondb/lib/x86_64-unknown-linux-gnu/
          cp target/release/toondb-bulk toondb-python-sdk/src/toondb/_bin/x86_64-unknown-linux-gnu/
          chmod +x toondb-python-sdk/src/toondb/_bin/x86_64-unknown-linux-gnu/toondb-bulk

      - name: Build wheel and sdist
        run: |
          cd toondb-python-sdk
          pip install build wheel
          python -m build
          cd dist
          for f in *-py3-none-any.whl; do
            newname=$(echo $f | sed 's/-py3-none-any/-py3-none-manylinux_2_17_x86_64/')
            mv "$f" "$newname"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x64
          path: toondb-python-sdk/dist/

  build-python-macos:
    name: Build Python (macOS ARM64)
    runs-on: macos-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'python' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust libraries
        run: |
          rustup target add aarch64-apple-darwin
          cargo build --release -p toondb-tools -p toondb-storage -p toondb-index --target aarch64-apple-darwin

      - name: Copy binaries to SDK
        run: |
          mkdir -p toondb-python-sdk/src/toondb/lib/aarch64-apple-darwin
          mkdir -p toondb-python-sdk/src/toondb/_bin/aarch64-apple-darwin
          cp target/aarch64-apple-darwin/release/libtoondb_storage.dylib toondb-python-sdk/src/toondb/lib/aarch64-apple-darwin/
          cp target/aarch64-apple-darwin/release/libtoondb_index.dylib toondb-python-sdk/src/toondb/lib/aarch64-apple-darwin/
          cp target/aarch64-apple-darwin/release/toondb-bulk toondb-python-sdk/src/toondb/_bin/aarch64-apple-darwin/
          chmod +x toondb-python-sdk/src/toondb/_bin/aarch64-apple-darwin/toondb-bulk

      - name: Build wheel
        run: |
          cd toondb-python-sdk
          pip install build wheel
          python -m build --wheel
          cd dist
          for f in *-py3-none-any.whl; do
            newname=$(echo $f | sed 's/-py3-none-any/-py3-none-macosx_11_0_arm64/')
            mv "$f" "$newname"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-macos-arm64
          path: toondb-python-sdk/dist/

  build-python-windows:
    name: Build Python (Windows x64)
    runs-on: windows-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'python' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust libraries
        run: cargo build --release -p toondb-tools -p toondb-storage -p toondb-index

      - name: Copy binaries to SDK
        run: |
          New-Item -ItemType Directory -Force -Path toondb-python-sdk\src\toondb\lib\x86_64-pc-windows-msvc
          New-Item -ItemType Directory -Force -Path toondb-python-sdk\src\toondb\_bin\x86_64-pc-windows-msvc
          Copy-Item target\release\toondb_storage.dll toondb-python-sdk\src\toondb\lib\x86_64-pc-windows-msvc\
          Copy-Item target\release\toondb_index.dll toondb-python-sdk\src\toondb\lib\x86_64-pc-windows-msvc\
          Copy-Item target\release\toondb-bulk.exe toondb-python-sdk\src\toondb\_bin\x86_64-pc-windows-msvc\

      - name: Build wheel
        run: |
          cd toondb-python-sdk
          pip install build wheel
          python -m build --wheel
          cd dist
          Get-ChildItem -Filter "*-py3-none-any.whl" | ForEach-Object {
            $newname = $_.Name -replace '-py3-none-any', '-py3-none-win_amd64'
            Rename-Item $_.FullName $newname
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x64
          path: toondb-python-sdk\dist\

  # ===========================================================================
  # Publish Python to PyPI
  # ===========================================================================
  publish-python:
    name: Publish to PyPI
    needs: [build-python-linux, build-python-macos, build-python-windows]
    runs-on: ubuntu-latest
    if: ${{ inputs.targets == 'all' || inputs.targets == 'python' }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-*
          path: wheels/
          merge-multiple: true

      - name: Validate and publish
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          echo "=== Packages to upload ==="
          ls -la wheels/
          twine check wheels/*
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” Dry run - skipping upload"
          else
            twine upload --skip-existing wheels/* \
              --username __token__ \
              --password $PYPI_API_TOKEN
          fi

  # ===========================================================================
  # Build and Publish npm package
  # ===========================================================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'npm' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Rust (for building binaries)
        uses: dtolnay/rust-toolchain@stable

      - name: Build toondb-bulk binary
        run: cargo build --release -p toondb-tools

      - name: Copy binary to npm package
        run: |
          mkdir -p toondb-js/_bin/x86_64-unknown-linux-gnu
          cp target/release/toondb-bulk toondb-js/_bin/x86_64-unknown-linux-gnu/
          chmod +x toondb-js/_bin/x86_64-unknown-linux-gnu/toondb-bulk

      - name: Install dependencies and build
        run: |
          cd toondb-js
          npm ci
          npm run build
          npm test

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd toondb-js
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” Dry run - validating package..."
            npm publish --dry-run --access public
          else
            npm publish --access public
          fi

  # ===========================================================================
  # Publish Go module (via git tag)
  # ===========================================================================
  publish-go:
    name: Publish Go Module
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.targets == 'all' || inputs.targets == 'go' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: toondb-go/go.sum

      - name: Test Go module
        run: |
          cd toondb-go
          go mod download
          go build -v ./...
          go test -v ./...

      - name: Create Go module tag
        if: ${{ inputs.dry_run != true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v${{ inputs.version }}"
          TAG="toondb-go/$VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping..."
          else
            echo "Creating tag: $TAG"
            git tag -a "$TAG" -m "Release toondb-go $VERSION"
            git push origin "$TAG"
          fi
          
          echo "Go module released: github.com/toondb/toondb/toondb-go@$VERSION"

      - name: Verify on Go proxy (dry run check)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "ðŸ” Dry run - would create tag: toondb-go/v${{ inputs.version }}"
          echo "Install command would be: go get github.com/toondb/toondb/toondb-go@v${{ inputs.version }}"

  # ===========================================================================
  # Release Summary
  # ===========================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm, publish-go]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ ToonDB Release v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "**Mode:** Dry Run (no packages published)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Production Release" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | \`toondb\` | ${{ needs.publish-rust.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI | \`toondb-client\` | ${{ needs.publish-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm | \`@sushanth/toondb\` | ${{ needs.publish-npm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go modules | \`github.com/toondb/toondb/toondb-go\` | ${{ needs.publish-go.result }} |" >> $GITHUB_STEP_SUMMARY
